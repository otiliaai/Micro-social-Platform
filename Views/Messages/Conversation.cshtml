@model IEnumerable<MicroSocialPlatform.Models.Message>
@using Microsoft.AspNetCore.Identity
@using MicroSocialPlatform.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    var otherUser = ViewData["OtherUser"] as ApplicationUser;
    var currentUserId = ViewData["CurrentUserId"] as string;

    // ✅ dictionary cu traduceri (setat în controller)
    var translatedDict = ViewData["Translated"] as Dictionary<int, string>;

    // (îl poți păstra sau elimina dacă nu mai folosești limbi multiple)
    var chatLang = (ViewData["ChatLang"] as string) ?? "ro";
    var returnUrl = Context.Request.Path + Context.Request.QueryString;

    // Logica pentru inițiale și nume
    var otherUserInitials = otherUser?.UserName?.Substring(0, 1).ToUpper() ?? "U";
    var otherUserFirstName = otherUser?.FirstName ?? "";
    var otherUserLastName = otherUser?.LastName ?? "";
    var otherUserFullName = $"{otherUserFirstName} {otherUserLastName}".Trim();
    if (string.IsNullOrEmpty(otherUserFullName)) otherUserFullName = otherUser?.UserName ?? "User";

    ViewData["Title"] = "Chat with " + otherUser?.UserName;
}

<div class="feed-container">
    <div class="custom-card mb-3">
        <div class="d-flex align-items-center justify-content-between p-3">
            <div class="d-flex align-items-center gap-3">
                <a asp-action="Index" class="btn btn-link p-0" style="color: var(--text-primary);">
                    <i class="bi bi-arrow-left" style="font-size: 1.2rem;"></i>
                </a>

                <div class="header-avatar">
                    @if (!string.IsNullOrEmpty(otherUser?.ProfileImage))
                    {
                        <img src="@otherUser.ProfileImage" alt="@otherUser.UserName" />
                    }
                    else
                    {
                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666;">
                            @otherUserInitials
                        </div>
                    }
                </div>

                <div>
                    <div style="font-weight: 600; color: var(--text-primary);">@otherUserFullName</div>
                    <small class="text-muted">@@@otherUser?.UserName</small>
                </div>
            </div>

            <div class="d-flex align-items-center gap-3">
                <!-- ✅ Language selector (poți elimina complet dacă traduci mereu în ro și nu mai ai SetChatLanguage) -->
                <form asp-action="SetChatLanguage" method="post" class="d-flex align-items-center gap-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="returnUrl" value="@returnUrl" />

                    <small class="text-muted" style="white-space: nowrap;">Language:</small>
                    <select name="lang" class="form-select form-select-sm"
                            style="width: 140px;"
                            onchange="this.form.submit()">
                        <option value="ro" selected="@(chatLang == "ro")">Română</option>
                        <option value="en" selected="@(chatLang == "en")">English</option>
                        <option value="fr" selected="@(chatLang == "fr")">Français</option>
                        <option value="de" selected="@(chatLang == "de")">Deutsch</option>
                        <option value="es" selected="@(chatLang == "es")">Español</option>
                        <option value="it" selected="@(chatLang == "it")">Italiano</option>
                    </select>
                </form>

                <form asp-action="DeleteConversation" asp-route-id="@otherUser?.Id" method="post"
                      onsubmit="return confirm('Ești sigur că vrei să ștergi TOATĂ conversația?');">
                    <button type="submit" class="btn btn-link text-muted p-0" title="Delete conversation">
                        <i class="bi bi-trash3" style="font-size: 1.1rem;"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="custom-card chat-main-wrapper">
        <div id="messages-container">
            @if (Model != null && Model.Any())
            {
                @foreach (var message in Model)
                {
                    var isCurrentUser = message.SenderId == currentUserId;
                    var sender = isCurrentUser ? await UserManager.GetUserAsync(User) : message.Sender;

                    var senderUserName = sender?.UserName ?? "user";
                    var senderInitials = senderUserName.Substring(0, 1).ToUpper();
                    var timeAgo = GetTimeAgo(message.CreatedAt);

                    // ✅ alegem textul care se afișează (tradus dacă există în dict)
                    var contentToShow =
                    (translatedDict != null &&
                    translatedDict.TryGetValue(message.Id, out var t) &&
                    !string.IsNullOrWhiteSpace(t))
                    ? t
                    : message.Content;

                    <div class="message-item @(isCurrentUser ? "message-own" : "message-other")">
                        <div class="message-avatar">
                            @if (!string.IsNullOrEmpty(sender?.ProfileImage))
                            {
                                <img src="@sender.ProfileImage" alt="p" />
                            }
                            else
                            {
                                <span>@senderInitials</span>
                            }
                        </div>

                        <div class="message-wrapper">
                            <div class="message-header d-flex align-items-center gap-2">
                                <span class="message-author">@(isCurrentUser ? "You" : senderUserName)</span>
                                <small class="text-muted" style="font-size: 0.7rem;">@timeAgo</small>

                                @if (isCurrentUser)
                                {
                                    <div class="dropdown">
                                        <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical" style="font-size: 0.8rem;"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                            <li>
                                                <a class="dropdown-item py-2 small" asp-action="Edit" asp-route-id="@message.Id">
                                                    <i class="bi bi-pencil me-2"></i> Edit
                                                </a>
                                            </li>
                                            <li>
                                                <form asp-action="DeleteMessage" asp-route-id="@message.Id" method="post">
                                                    <button type="submit" class="dropdown-item text-danger py-2 small">
                                                        <i class="bi bi-trash me-2"></i> Delete
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                }
                            </div>

                            <div class="message-text">
                                @contentToShow
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center text-muted my-auto">
                    <i class="bi bi-chat-dots mb-2" style="font-size: 2rem;"></i>
                    <p>No messages yet. Start the conversation!</p>
                </div>
            }
        </div>

        <div class="message-input-area">
            <form id="message-form" class="d-flex gap-2">
                <input type="hidden" name="receiverId" value="@otherUser?.Id" />
                <input type="text" id="message-input" class="form-control big-chat-input"
                       placeholder="Type a message..." required autocomplete="off">
                <button type="submit" class="btn btn-purple-circle shadow-sm">
                    <i class="bi bi-send-fill"></i>
                </button>
            </form>
        </div>
    </div>
</div>

@functions {
    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        if (timeSpan.TotalSeconds < 60) return "just now";
        if (timeSpan.TotalMinutes < 60) return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24) return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7) return $"{(int)timeSpan.TotalDays}d ago";
        return dateTime.ToString("MMM dd, yyyy");
    }
}

<style>
    .chat-main-wrapper {
        height: 600px;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 15px;
        overflow: hidden;
    }

    #messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: #f8f9fa;
    }

    /* Mesaje */
    .message-item {
        display: flex;
        gap: 10px;
        width: 100%;
        align-items: flex-end;
    }

    .message-own {
        flex-direction: row-reverse;
    }

    .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 75%;
    }

    .message-own .message-wrapper {
        align-items: flex-end;
    }

    .message-text {
        padding: 10px 15px;
        border-radius: 18px;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .message-other .message-text {
        background-color: #ffffff;
        color: #333;
        border-bottom-left-radius: 4px;
        border: 1px solid #eef0f3;
    }

    .message-own .message-text {
        background: linear-gradient(135deg, #7BA3E8 0%, #B5A8D8 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-own .message-author {
        display: none;
    }

    .message-avatar, .header-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #eee;
        flex-shrink: 0;
        font-weight: bold;
    }

        .message-avatar img, .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .message-author {
        font-size: 0.75rem;
        font-weight: bold;
        color: #666;
    }

    /* Input Area */
    .message-input-area {
        padding: 15px;
        border-top: 1px solid #eee;
        background: white;
    }

    .big-chat-input {
        height: 50px !important;
        border-radius: 25px !important;
        padding-left: 20px !important;
        border: 1px solid #e0e0e0 !important;
        background-color: #f8f9fa;
    }

        .big-chat-input:focus {
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(123, 163, 232, 0.2);
        }

    .btn-purple-circle {
        background: linear-gradient(135deg, #7BA3E8 0%, #B5A8D8 100%);
        color: #fff;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

        .btn-purple-circle:hover {
            transform: scale(1.05);
            color: white;
        }
</style>

<script>
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');

    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    if (messageForm) {
        messageForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const content = messageInput.value.trim();
            if (!content) return;

            const receiverId = '@otherUser?.Id';

            const formData = new FormData();
            formData.append('receiverId', receiverId);
            formData.append('content', content);

            try {
                const response = await fetch('@Url.Action("Send", "Messages")', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error('Send failed:', response.status, text);
                    alert('Failed to send message.');
                    return;
                }

                let data;
                try {
                    data = await response.json();
                } catch (err) {
                    const text = await response.text();
                    console.error('Invalid JSON:', text);
                    alert('Failed to send message.');
                    return;
                }

                if (!data.success) {
                    alert('Failed to send message.');
                    return;
                }

                const safeContent = (data.message.content ?? '').toString();

                const messageHtml = `
                    <div class="message-item message-own" style="margin-bottom: 16px;">
                        <div class="message-avatar"><span>ME</span></div>
                        <div class="message-wrapper">
                            <div class="message-text">${safeContent}</div>
                        </div>
                    </div>
                `;

                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                messageInput.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Network error:', error);
                alert('Failed to send message.');
            }
        });
    }
</script>
